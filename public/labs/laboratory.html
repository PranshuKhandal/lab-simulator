<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Laboratory</title>
	<link rel="stylesheet" href="/css/typography.css">
	<link rel="stylesheet" href="/css/screen.css">
	<link rel="stylesheet" href="/css/icon.css">
	<style>

/* */h1::before{content:""}/* */
#markdown p {
	text-align: justify;
}
#markdown ol li {
	padding-left: 10px;
}
.links-container  .material-icons {
	font-size: 20px;
	line-height: 20px;
	vertical-align: sub;
}
.links-container {
	text-transform: capitalize;
	text-align: center;
}
.links-container span::after {
	content: ", ";
}
.links-container span:last-of-type:after {
	content: "";
}

	</style>
</head>
<body>
	<p>You are here: <a href="/">Home</a> <span class=u>&#8227;</span> <a href="?phy1"><span id="nav-title"></span></a> <span class=u>&#8227;</span></p>
	<h1></span><span id="course"></span> lab</h1>
	<p class="a">&#x2767;</p>
	<h2 id="title"></h2>
	<div class="links-container"></div>
	<div id="markdown"></div>
	<div class="links-container"></div>
	
	<style id="link-styles"></style>
    <script src="/js/Markdown.Converter.js"></script>
    <script src="/js/Markdown.Sanitizer.js"></script>
    <script>

var JSON;
var HOME = "";
const validMD = [ "theory", "reference" ];
let hasSimulation = false;
const converter = new Markdown.Converter();
const links = Array.from( document.querySelectorAll( ".links-container" ) );
const linkStyles = document.querySelector( "#link-styles" );

var headers = new Headers();
headers.append( "pragma", "no-cache" );
headers.append( "cache-control", "no-cache" );

var init = { method: 'GET', headers: headers };

validMD.forEach( item => {
	const a = document.createElement( "a" );
	a.href = "#" + item;
	a.innerText = item;
	const s = document.createElement( "span" );
	s.classList.add( "link-" + item );
	s.appendChild( a );
	links.forEach( elm => elm.appendChild( s.cloneNode( true ) ) );
} );

function add1head( md ) {
	return md.replaceAll( /^#/gm, "##" );
}

window.addEventListener( "load", function() {
	const simName = window.location.search.split( "?" )[ 1 ];
    const name = simName.substring( 0, 3 );
	const id = Number( simName.substring( 3 ) );
	HOME = `${ name }/sim${ id }/`;
	fetch( HOME + "export.json", init )
		.then( response => response.json() )
		.then( json => ( JSON = json ) )
		.then( () => hasSimulation = JSON.simulation !== null )
		.then( () => {
			if ( !hasSimulation ) return;
			const googleIcon = document.createElement( "span" );
			googleIcon.classList.add( "material-icons" );
			googleIcon.innerText = "open_in_new";
			const a = document.createElement( "a" );
			a.innerText = "simulation";
			a.href = HOME + JSON.simulation;
			a.target = "_blank";
			a.appendChild( googleIcon );
			const s = document.createElement( "span" );
			s.appendChild( a );
			links.forEach( elm => elm.appendChild( s.cloneNode( true ) ) );
		} )
		.then( () => document.querySelector( "#nav-title" ).innerText = JSON.title )
		.then( () => document.querySelector( "#title" ).innerText = JSON.title )
		.then( () => document.querySelector( "#course" ).innerText = JSON.course )
		.then( () => document.title = `${ JSON.course } Lab | ${ JSON.title }` )
		.then( () => window.dispatchEvent( new HashChangeEvent( "hashchange" ) ) );
} );

function loadMD( md ) {
	fetch( HOME + JSON[ md ], init )
		.then( response => response.text() )
		.then( text => document.querySelector( "#markdown" ).innerHTML = converter.makeHtml( add1head( text ) ) );
}

window.addEventListener( "hashchange", function() {
	let md = "theory";
	const hash = window.location.hash.split( "#" )[ 1 ];
	if ( validMD.indexOf( hash ) > -1 ) md = hash;
	else window.location.hash = md;
	linkStyles.innerHTML = `.link-${ hash } a{color:FireBrick!important;font-weight:bold}`;
	loadMD( md );
} );

	</script>
</body>
</html>